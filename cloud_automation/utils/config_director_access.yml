---
- hosts: director
  gather_facts: false
  become: yes
  vars:
    automation_user: awx
    dns_servers:
      - 159.107.173.3
      - 159.107.173.12
  tasks:
    - name: 'Create {{ automation_user }} user on director'
      user:
        name: '{{ automation_user }}'
        password: $6$omu6IQS6.C6jcJqV$7ktgP/5F6eaUr2hFIWK52R1NNIV/RnqEogGCt7jRuVSfqePqHV5rA6IchnLVSg7atcODxvfQzOtcuBkPoCXUA1
        state: present
        generate_ssh_key: yes
        ssh_key_bits: 4096
        ssh_key_comment: Generated by AWX/Ansible Tower Automation


    - name: "Add {{automation_user}} user's public key to authorized_keys file"
      authorized_key:
        user: '{{ automation_user }}'
        state: present
        key: '{{ lookup("file","awx_ssh.pub") }}'

    - name: Get SSH Host key from director
      slurp:
        path: /etc/ssh/ssh_host_ecdsa_key.pub
      register: director_host_key
   
    - name: Add the director's host key to the .ssh/known_hosts file
      known_hosts:
        name: '{{ ansible_host }}'
        key: "{{ ansible_host + ',' + lookup('dig',ansible_host, '@' + dns_servers|first) + ' ' + director_host_key['content'] | b64decode | regex_replace('\\n','') }}"
        path: '/root/.ssh/known_hosts'
      delegate_to: localhost
